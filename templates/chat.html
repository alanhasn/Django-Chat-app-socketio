{% extends "base.html" %}

{% block content %}

<script src="https://cdn.tailwindcss.com"></script>


<div class="bg-gray-200 min-h-screen flex flex-col">
  <header class="bg-teal-700 text-white p-4 text-center font-bold text-lg shadow-md">
    {{ room_name }} Chat Room
  </header>

  <div class="flex-1 flex flex-col max-w-2xl w-full mx-auto p-4">
    <div class="text-center text-gray-600 mb-4">
      You are chatting as <strong>{{ username }}</strong>
    </div>

    <div class="flex-1 overflow-y-auto bg-gray-100 rounded-lg p-4 shadow-inner" id="chat-messages">
      {% for message in messages %}
        <div class="flex mb-3 {% if message.is_current_user %}justify-end{% else %}justify-start{% endif %}">
          <div class="rounded-lg p-2 max-w-md {% if message.is_current_user %}bg-green-200{% else %}bg-white{% endif %}">
            <div class="text-sm text-gray-800">
              {% if not message.is_system and not message.is_current_user %}
                <div class="font-bold text-teal-700">{{ message.username }}</div>
              {% endif %}
              {{ message.content }}
            </div>
            <div class="text-xs text-right text-gray-500 mt-1">
              {{ message.timestamp|date:"H:i" }}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="mt-4 flex">
      <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" class="flex-1 rounded-l-full border-none p-3 focus:ring-0">
      <button id="send-button" class="bg-teal-600 text-white rounded-r-full px-6 py-3 font-bold hover:bg-teal-700">Send</button>
    </div>
  </div>
</div>

{% endblock %}


{% block extra_js %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const roomName = "{{ room_name|lower }}";
      const username = "{{ username }}";
      const socket = io();

      // Join the room
      socket.emit('join', { username: username, room: roomName });

      // Handle incoming messages
      socket.on('message', function(data) {
          appendMessage(data);
      });

      function appendMessage(data) {
          const messagesContainer = document.getElementById('chat-messages');
          const isSystem = data.username === 'System';
          const isCurrentUser = data.username === username;

          const messageWrapper = document.createElement('div');
          messageWrapper.className = `flex mb-3 ${isCurrentUser ? 'justify-end' : 'justify-start'}`;

          let messageElement;
          if (isSystem) {
              messageElement = document.createElement('div');
              messageElement.className = 'text-center text-gray-500 italic my-2';
              messageElement.textContent = data.message;
              messagesContainer.appendChild(messageElement);
          } else {
              messageElement = document.createElement('div');
              messageElement.className = `rounded-lg p-2 max-w-md ${isCurrentUser ? 'bg-green-200' : 'bg-white'}`;
              messageElement.innerHTML = `
                  <div class="text-sm text-gray-800">
                      ${!isCurrentUser ? `<div class="font-bold text-teal-700">${data.username}</div>` : ''}
                      ${data.message}
                  </div>
                  <div class="text-xs text-right text-gray-500 mt-1">
                      ${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                  </div>
              `;
              messageWrapper.appendChild(messageElement);
              messagesContainer.appendChild(messageWrapper);
          }
          
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      const messageInput = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');

      function sendMessage() {
          const message = messageInput.value.trim();
          if (message) {
              socket.emit('send_message', { message: message });
              messageInput.value = '';
          }
      }

      sendButton.addEventListener('click', sendMessage);
      messageInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') sendMessage();
      });
  });
</script>


{% endblock %}